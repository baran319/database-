<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ domain }} - Database Architecture Report</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
    
    <script>
        // Mermaid'i sayfa baÅŸÄ±nda yapÄ±landÄ±rÄ±yoruz
        mermaid.initialize({ 
            startOnLoad: false, 
            theme: 'dark', 
            securityLevel: 'loose',
            fontFamily: 'Plus Jakarta Sans',
            er: { useMaxWidth: true, layoutDirection: 'TB' }
        });
    </script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&display=swap');
        
        body { 
            font-family: 'Plus Jakarta Sans', sans-serif; 
            background: radial-gradient(circle at top right, #0f172a, #020617); 
            color: #cbd5e1;
            scroll-behavior: smooth;
        }

        /* Glassmorphism efekti */
        .glass-card { 
            background: rgba(15, 23, 42, 0.7); 
            backdrop-filter: blur(12px); 
            border: 1px solid rgba(255,255,255,0.05);
        }

        .nav-btn { 
            color: #94a3b8; 
            border: 1px solid rgba(255,255,255,0.05); 
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .active-btn { 
            background: #2563eb !important; 
            color: white !important; 
            box-shadow: 0 0 20px rgba(37, 99, 235, 0.4); 
            border-color: #3b82f6;
        }

        /* Tablo Stilleri */
        table { width: 100%; border-collapse: collapse; margin: 1.5rem 0; background: rgba(15, 23, 42, 0.4); border-radius: 1rem; overflow: hidden; border: 1px solid rgba(255,255,255,0.1); }
        th { background: rgba(30, 41, 59, 0.8); padding: 1rem; text-align: left; color: #60a5fa; border-bottom: 2px solid #334155; font-size: 0.8rem; text-transform: uppercase; }
        td { padding: 1rem; border-bottom: 1px solid rgba(30, 41, 59, 0.5); font-size: 0.9rem; color: #cbd5e1; }
        tr:hover { background: rgba(51, 65, 85, 0.2); }

        .fade-in { animation: fadeIn 0.4s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        @media print { .no-print { display: none; } }
    </style>
</head>
<body class="p-4 md:p-8 min-h-screen relative">

    <div id="loading-overlay" class="hidden fixed inset-0 bg-slate-950/95 z-[100] flex flex-col items-center justify-center">
        <div class="w-20 h-20 border-4 border-blue-500 border-t-transparent rounded-full animate-spin mb-4"></div>
        <h2 id="loading-text" class="text-2xl font-black text-white mb-2 uppercase tracking-tighter">Updating System</h2>
        <p class="text-slate-400 animate-pulse italic">AI is processing logic...</p>
    </div>

    <div class="max-w-6xl mx-auto">
        <div class="flex justify-between items-center mb-8 no-print">
            <div>
                <span class="text-blue-500 font-bold uppercase tracking-widest text-xs">Architectural Design</span>
                <h2 class="text-3xl font-black text-white uppercase tracking-tighter">{{ domain }}</h2>
            </div>
            <div class="flex gap-2">
                <button onclick="window.print()" class="bg-emerald-600 hover:bg-emerald-500 text-white px-5 py-2.5 rounded-xl font-bold transition-all transform active:scale-95">EXPORT PDF</button>
                <a href="/" class="bg-slate-800 hover:bg-slate-700 text-white px-5 py-2.5 rounded-xl font-bold border border-slate-700 transition-all">NEW PROJECT</a>
            </div>
        </div>

        <div class="flex flex-wrap gap-2 mb-6 no-print bg-slate-900/50 p-3 rounded-2xl border border-slate-800 sticky top-4 z-50 backdrop-blur-md">
            <button onclick="showStage('stage1', this)" class="nav-btn active-btn px-4 py-2 rounded-lg font-bold">1. Summary</button>
            <button onclick="showStage('stage2', this)" class="nav-btn px-4 py-2 rounded-lg font-bold">2. Rules</button>
            <button onclick="showStage('stage3', this)" class="nav-btn px-4 py-2 rounded-lg font-bold">3. Tables</button>
            <button onclick="showStage('stage4', this)" class="nav-btn px-4 py-2 rounded-lg font-bold">4. Gaps</button>
            <button onclick="showStage('stage5', this)" class="nav-btn px-4 py-2 rounded-lg font-bold">5. Normalization</button>
            <button onclick="showStage('stage6', this)" class="nav-btn px-4 py-2 rounded-lg font-bold">6. ERD</button>
            <button onclick="showStage('stage7', this)" class="nav-btn px-4 py-2 rounded-lg font-bold">7. SQL</button>
        </div>

        <div class="glass-card shadow-2xl min-h-[70vh] rounded-3xl overflow-hidden border border-white/5">
            <div id="report-content" class="p-6 md:p-10">
                {{ content | safe }}
            </div>
        </div>
    </div>

    <div class="fixed bottom-8 right-8 z-50 no-print group">
        <div class="absolute inset-0 bg-red-600 rounded-full blur opacity-40 group-hover:opacity-75 transition-opacity duration-500"></div>
        <button onclick="deployToXampp()" class="relative flex items-center gap-3 bg-gradient-to-r from-red-600 to-rose-700 hover:from-red-500 hover:to-rose-600 text-white font-bold py-4 px-8 rounded-full shadow-2xl transition-all transform hover:scale-105 border-2 border-red-400/30">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 7v10c0 2.21 3.582 4 8 4s8-1.79 8-4V7M4 7c0 2.21 3.582 4 8 4s8-1.79 8-4M4 7c0-2.21 3.582-4 8-4s8 1.79 8 4m0 5c0 2.21-3.582 4-8 4s-8-1.79-8-4"></path></svg>
            <span class="tracking-wider">DEPLOY TO XAMPP</span>
        </button>
    </div>

    <script>
        const pDataString = '{{ p_data_json | safe }}';

        // Mermaid Render Motoru (Kritik Alan)
        async function renderMermaid() {
            const srcEl = document.querySelector('.mermaid-src');
            const targetEl = document.querySelector('.mermaid-target');
            if (!srcEl || !targetEl) return;

            // HTML karakterlerini ve gereksiz boÅŸluklarÄ± temizle
            let code = srcEl.textContent
                .replace(/&lt;/g, '<')
                .replace(/&gt;/g, '>')
                .replace(/&amp;/g, '&')
                .replace(/```mermaid/g, '')
                .replace(/```/g, '')
                .trim();

            // Kodun baÅŸÄ±nda erDiagram olduÄŸundan emin ol
            if (!code.startsWith('erDiagram')) {
                const fixPos = code.indexOf('erDiagram');
                if (fixPos !== -1) code = code.substring(fixPos);
                else code = 'erDiagram\n' + code;
            }

            // Target'Ä± temizle ve kodu bas
            targetEl.innerHTML = `<div class="mermaid">${code}</div>`;
            
            try {
                // Mermaid motorunu Ã§alÄ±ÅŸtÄ±r
                await mermaid.run({
                    nodes: targetEl.querySelectorAll('.mermaid')
                });
            } catch (err) {
                console.error("Mermaid Render Error:", err);
                targetEl.innerHTML = `
                    <div class="p-6 bg-red-900/20 text-red-400 rounded-2xl border border-red-500/50">
                        <p class="font-bold">Diagram Error</p>
                        <p class="text-xs opacity-70">Syntax Error in AI output. Try clicking "FIX IT" to regenerate.</p>
                    </div>`;
            }
        }

        // Navigasyon MantÄ±ÄŸÄ±
        function showStage(stageId, btn) {
            // TÃ¼m aÅŸamalarÄ± gizle
            document.querySelectorAll('[id^="stage"]').forEach(s => s.style.display = 'none');
            
            // Hedef aÅŸamayÄ± gÃ¶ster
            const target = document.getElementById(stageId);
            if (target) {
                target.style.display = 'block';
                target.classList.add('fade-in');
            }

            // Buton durumlarÄ±nÄ± gÃ¼ncelle
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active-btn'));
            if (btn) btn.classList.add('active-btn');

            // EÄŸer ERD sekmesindeysek diyagramÄ± Ã§iz
            if (stageId === 'stage6') {
                setTimeout(renderMermaid, 100);
            }
        }

        // FIX IT butonu tÄ±klandÄ±ÄŸÄ±nda Ã§alÄ±ÅŸan AJAX fonksiyonu
        window.fixMissingRule = async function(ruleText) {
            document.getElementById('loading-text').innerText = "Updating System";
            document.getElementById('loading-overlay').classList.remove('hidden');

            try {
                const projectData = JSON.parse(pDataString);
                const response = await fetch('/fix_rule', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        p_data: projectData,
                        rule: ruleText
                    })
                });

                const result = await response.json();

                if (result.status === 'success') {
                    // Ä°Ã§eriÄŸi gÃ¼ncelle
                    document.getElementById('report-content').innerHTML = result.new_content;
                    
                    // DOM gÃ¼ncellendikten sonra Mermaid'i Ã§iz ve Stage 6'ya odaklan
                    setTimeout(() => {
                        renderMermaid();
                        const erdBtn = document.querySelectorAll('.nav-btn')[5]; // Stage 6 butonu
                        showStage('stage6', erdBtn);
                    }, 300);

                    alert(`âœ… Kural Eklendi: "${ruleText}"\nSistem yeniden yapÄ±landÄ±rÄ±ldÄ±.`);

                } else {
                    alert("Fix failed: " + result.message);
                }
            } catch (error) {
                console.error("AJAX Error:", error);
                alert("Connection lost. Please try again.");
            } finally {
                document.getElementById('loading-overlay').classList.add('hidden');
            }
        };

        // --- YENÄ° EKLENEN: XAMPP DEPLOYMENT FONKSÄ°YONU ---
        window.deployToXampp = async function() {
            if(!confirm("âš ï¸ DÄ°KKAT!\n\nBu iÅŸlem XAMPP veritabanÄ±na baÄŸlanacak ve:\n1. TablolarÄ± oluÅŸturacak,\n2. Business Rule'larÄ± kaydedecek.\n\nDevam edilsin mi?")) return;

            // YÃ¼kleniyor ekranÄ±nÄ± aÃ§
            document.getElementById('loading-text').innerText = "Deploying to XAMPP";
            document.getElementById('loading-overlay').classList.remove('hidden');

            try {
                // 1. Stage 7'deki SQL KodlarÄ±nÄ± Topla
                let sqlContent = "";
                document.querySelectorAll('#stage7 pre').forEach(pre => {
                    sqlContent += pre.innerText + "\n";
                });

                // 2. Stage 2'deki Business Rule'larÄ± Topla (Fix edilenler dahil!)
                let rules = [];
                document.querySelectorAll('#stage2 table tbody tr').forEach(tr => {
                    let cols = tr.querySelectorAll('td');
                    if(cols.length >= 2) {
                        rules.push({
                            id: cols[0].innerText.trim(),  // ID
                            desc: cols[1].innerText.trim() // Description
                        });
                    }
                });

                // 3. VeritabanÄ± ismini domain'den tÃ¼ret
                let domainName = "{{ domain }}".trim() || "my_project";
                let dbName = domainName.toLowerCase()
                    .replace(/ /g, '_')
                    .replace(/Ã§/g, 'c').replace(/ÄŸ/g, 'g').replace(/Ä±/g, 'i').replace(/Ã¶/g, 'o').replace(/ÅŸ/g, 's').replace(/Ã¼/g, 'u') 
                    + "_db";

                // 4. Backend'e GÃ¶nder
                const response = await fetch('/deploy_to_xampp', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        sql_code: sqlContent,
                        business_rules: rules,
                        db_name: dbName
                    })
                });

                const result = await response.json();

                if(result.status === 'success') {
                    alert("ðŸŽ‰ BAÅžARILI!\n\n" + result.message + "\n\nVeritabanÄ± XAMPP Ã¼zerinde oluÅŸturuldu.");
                } else {
                    alert("âŒ HATA: " + result.message);
                }

            } catch (err) {
                alert("Sistem HatasÄ±: " + err);
            } finally {
                // YÃ¼kleniyor ekranÄ±nÄ± kapat
                document.getElementById('loading-overlay').classList.add('hidden');
            }
        }

        // Sayfa aÃ§Ä±ldÄ±ÄŸÄ±nda 1. aÅŸamayÄ± gÃ¶ster
        window.onload = () => {
            showStage('stage1', document.querySelector('.nav-btn'));
        };
    </script>
</body>
</html>